@page "/tramites"
@using Luxprop.Data.Models
@using Microsoft.EntityFrameworkCore
@inject LuxpropContext Db

<PageTitle>Trámites - Luxprop</PageTitle>

<div class="documents-page">
    <div class="page-header">
        <h1>Trámites</h1>

        <!-- ▒▒▒ FILTROS ▒▒▒ -->
        <div class="header-actions">

            <!-- FILTRO POR ESTADO -->
            <select @onchange="OnEstadoFilterChanged" class="form-select" style="max-width:180px;">
                <option value="">-- All Status --</option>
                @foreach (var estado in estadosDisponibles)
                {
                    <option value="@estado">@estado</option>
                }
            </select>

            <!-- FILTRO POR EXPEDIENTE -->
            <select @onchange="OnExpedienteFilterChanged" class="form-select" style="max-width:180px;">
                <option value="">-- All Expedientes --</option>
                @foreach (var exp in expedientesDisponibles)
                {
                    <option value="@exp">Expediente @exp</option>
                }
            </select>
        </div>
    </div>

    @if (tareas == null)
    {
        <div class="loading">Loading tasks...</div>
    }
    else if (!tareas.Any())
    {
        <div class="no-data">No tasks found.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Tarea ID</th>
                        <th>Expediente</th>
                        <th>Título</th>
                        <th>Estado</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Cierre</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var t in tareas)
                    {
                        <tr>
                            <td>@t.TareaId</td>
                            <td>@t.ExpedienteId</td>
                            <td>@t.Titulo</td>
                            <td>
                                <span class="badge @(t.Estado == "Done" ? "bg-success" : "bg-warning")">
                                    @t.Estado
                                </span>
                            </td>
                            <td>@(t.FechaInicio?.ToString("yyyy-MM-dd") ?? "—")</td>
                            <td>@(t.FechaCierre?.ToString("yyyy-MM-dd") ?? "—")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {

    private List<TareaTramite>? tareas;
    private string selectedEstado = "";
    private string selectedExpediente = "";

    private List<string> estadosDisponibles = new()
    {
        "Pending",
        "Done"
    };

    private List<int> expedientesDisponibles = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTareas();
        LoadExpedientes();
    }

    private async Task LoadTareas()
    {
        tareas = await Db.Set<TareaTramite>().ToListAsync();
    }

    private void LoadExpedientes()
    {
        expedientesDisponibles = Db.TareaTramites
            .Select(t => t.ExpedienteId)
            .Distinct()
            .OrderBy(x => x)
            .ToList();
    }

    private void OnEstadoFilterChanged(ChangeEventArgs e)
    {
        selectedEstado = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void OnExpedienteFilterChanged(ChangeEventArgs e)
    {
        selectedExpediente = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = Db.TareaTramites.AsQueryable();

        if (!string.IsNullOrEmpty(selectedEstado))
            query = query.Where(t => t.Estado == selectedEstado);

        if (!string.IsNullOrEmpty(selectedExpediente))
            query = query.Where(t => t.ExpedienteId.ToString() == selectedExpediente);

        tareas = query.ToList();
        StateHasChanged();
    }
}

<style>
    .documents-page {
        padding: 2rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .page-header h1 {
        margin: 0;
        color: #0d505a;
    }

    .badge {
        font-size: .9rem;
        padding: .4rem .6rem;
    }
</style>
