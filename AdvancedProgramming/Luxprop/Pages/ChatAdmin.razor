@page "/chatadmin"
@using Luxprop.Data.Models
@using Luxprop.Business.Services
@inject IChatService ChatService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Admin Chat - 2CRRE Docs</PageTitle>

<div class="admin-page">
    <div class="admin-chat-card">

        <!-- SIDEBAR -->
        <aside class="admin-sidebar">
            <h3 class="sidebar-title">Active Chats</h3>

            <div class="sidebar-list">
                @if (threads?.Any() == true)
                {
                    @foreach (var t in threads)
                    {
                        <div class="sidebar-thread @(t.ChatThreadId == currentThreadId ? "active" : "")"
                             @onclick="() => SelectThread(t.ChatThreadId)">

                            <div class="thread-avatar">
                                <span>@t.ClientName?.FirstOrDefault()</span>
                            </div>

                            <div class="thread-info">
                                <strong>@t.ClientName</strong>
                                <small>@t.ClientEmail</small>
                            </div>

                            @if (t.NeedsAgent)
                            {
                                <span class="thread-dot"></span>
                            }
                        </div>
                    }
                }
                else
                {
                    <p class="empty-threads">No active chats ðŸ’¤</p>
                }
            </div>
        </aside>

        <!-- MAIN CHAT PANEL -->
        <section class="admin-chat-area">

            @if (currentThreadId == 0)
            {
                <div class="placeholder">
                    <h2>Select a conversation</h2>
                    <p>You can view and reply to customer chats here.</p>
                </div>
            }
            else
            {
                <!-- CHAT HEADER -->
                <div class="admin-chat-header">
                    <div class="header-left">
                        <div class="header-avatar">
                            <img src="/img/marty.png" alt="Marty" />
                        </div>

                        <div>
                            <h3>@currentClientName</h3>
                            <p class="online-status">
                                <span class="online-dot"></span>
                                Active chat
                            </p>
                        </div>
                    </div>

                    <button class="close-chat-btn" @onclick="CloseChat">Close Chat</button>
                </div>

                <!-- MESSAGE LIST -->
                <div class="admin-message-box" @ref="messagesContainer">
                    @foreach (var msg in messages)
                    {
                        var sender = msg.Sender.ToLower();

                        <div class="msg-row @sender">

                            @if (sender == "client")
                            {
                                <div class="msg-avatar user-avatar">@msg.Sender[..1]</div>
                                <div class="msg-bubble client">@msg.Text</div>
                            }

                            @if (sender == "bot")
                            {
                                <div class="msg-avatar bot-avatar-sm">
                                    <img src="/img/marty.png" />
                                </div>
                                <div class="msg-bubble bot">@msg.Text</div>
                            }

                            @if (sender == "agent")
                            {
                                <div class="msg-bubble agent">@msg.Text</div>
                                <div class="msg-avatar agent-avatar">A</div>
                            }
                        </div>
                    }
                </div>

                <!-- INPUT BOX -->
                <EditForm Model="@newMessage" OnValidSubmit="@SendMessage">
                    <div class="admin-input-box">
                        <InputText @bind-Value="newMessage.Text"
                                   class="admin-input"
                                   placeholder="Type a message..." />

                        <button class="admin-send-btn"
                                disabled="@string.IsNullOrWhiteSpace(newMessage.Text)">
                            Send
                        </button>
                    </div>
                </EditForm>
            }
        </section>
    </div>
</div>

@code {
    private List<ChatThread> threads = new();
    private List<ChatMessage> messages = new();
    private ChatMessage newMessage = new();
    private ElementReference messagesContainer;
    private int currentThreadId;
    private string? currentClientName;

    private Timer? pollTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadThreads();
        StartPolling();
    }

    private async Task LoadThreads()
    {
        threads = await ChatService.GetActiveThreadsAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SelectThread(int threadId)
    {
        currentThreadId = threadId;

        var thread = threads.FirstOrDefault(t => t.ChatThreadId == threadId);
        currentClientName = thread?.ClientName ?? "Client";

        messages = await ChatService.GetMessagesAsync(threadId);
        await ScrollToBottom();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage.Text)) return;

        await ChatService.AddAgentMessageAsync(currentThreadId, newMessage.Text);
        newMessage.Text = string.Empty;

        messages = await ChatService.GetMessagesAsync(currentThreadId);
        await ScrollToBottom();
    }

    private async Task CloseChat()
    {
        if (currentThreadId == 0) return;

        await ChatService.CloseChatAsync(currentThreadId);

        currentThreadId = 0;
        messages.Clear();

        await LoadThreads();
    }

    private void StartPolling()
    {
        pollTimer = new Timer(async _ =>
        {
            await LoadThreads();

            if (currentThreadId > 0)
                messages = await ChatService.GetMessagesAsync(currentThreadId);

            await InvokeAsync(StateHasChanged);

        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(4));
    }

    private async Task ScrollToBottom()
    {
        try { await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
    }

    public void Dispose() => pollTimer?.Dispose();
}

<style>

    :root {
        --primary: #05445E; /* Azul encabezado */
        --accent: #4CB9B0; /* Verde agua */
        --bg-light: #F5F8FB; /* Fondo clarito */
        --bubble-bot: #EAF6F6;
    }

    .admin-page {
        padding: 2rem;
        background: var(--bg-light);
        height: calc(100vh - 40px);
    }

    .admin-chat-card {
        width: 100%;
        height: 90vh;
        max-width: 1300px;
        margin: 0 auto;
        display: flex;
        border-radius: 18px;
        overflow: hidden;
        background: white;
        box-shadow: 0 12px 35px rgba(0,0,0,0.08);
    }

    /* SIDEBAR */
    .admin-sidebar {
        width: 30%;
        background: white;
        padding: 1.2rem;
        border-right: 1px solid #E2E8F0;
        overflow-y: auto;
    }

    .sidebar-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 1rem;
    }

    .sidebar-thread {
        display: flex;
        align-items: center;
        gap: 0.9rem;
        padding: 0.85rem 1rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.18s ease;
        background: #FFFFFF;
        margin-bottom: 0.6rem;
        border: 1px solid transparent;
    }

        .sidebar-thread:hover {
            background: #EAF7F7;
        }

        .sidebar-thread.active {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white !important;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
        }

    .thread-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        font-weight: 700;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .thread-info strong {
        font-size: 0.93rem;
    }

    .thread-info small {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .thread-dot {
        position: absolute;
        top: 12px;
        right: 10px;
        width: 10px;
        height: 10px;
        background: #ef4444;
        border-radius: 50%;
    }

    /* MAIN CHAT */
    .admin-chat-area {
        flex: 1;
        padding: 1.3rem;
        display: flex;
        flex-direction: column;
        background: var(--bg-light);
    }

    /* HEADER */
    .admin-chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        padding: 1rem 1.3rem;
        border-radius: 14px;
        color: white;
        margin-bottom: 1rem;
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 0.9rem;
    }

    .header-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        overflow: hidden;
        background: white;
        border: 3px solid var(--accent);
    }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .online-status {
        font-size: 0.8rem;
        opacity: 0.9;
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    .online-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
    }

    .close-chat-btn {
        background: #ef4444;
        border: none;
        padding: 0.55rem 1.1rem;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.18s;
    }

    .admin-message-box {
        flex: 1;
        background: white;
        border-radius: 14px;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        box-shadow: inset 0 0 12px rgba(0,0,0,0.04);
    }

    .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
    }

        .msg-row.agent {
            justify-content: flex-end;
        }

    .msg-bubble {
        max-width: 70%;
        padding: 0.8rem 1.1rem;
        border-radius: 14px;
        font-size: 0.95rem;
        background: #FFFFFF;
        box-shadow: 0px 2px 10px rgba(0,0,0,0.05);
    }

        .msg-bubble.client {
            background: #fff;
        }

        .msg-bubble.bot {
            background: var(--bubble-bot);
            border-left: 4px solid var(--accent);
        }

        .msg-bubble.agent {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
        }

    .msg-avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #E2E8F0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
    }

    .bot-avatar-sm {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid var(--accent);
    }

        .bot-avatar-sm img {
            width: 100%;
            height: 100%;
        }

    .agent-avatar {
        background: var(--primary);
        color: white;
    }

    .user-avatar {
        background: #4CB9B033;
        color: var(--primary);
        font-weight: 700;
    }

    /* INPUT */
    .admin-input-box {
        display: flex;
        background: white;
        border-radius: 14px;
        padding: 0.5rem;
        margin-top: 1rem;
        gap: 0.5rem;
        box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }

    .admin-input {
        flex: 1;
        border: none;
        outline: none;
        background: #F0F4F8;
        padding: 0.8rem 1rem;
        border-radius: 12px;
    }

    .admin-send-btn {
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border: none;
        padding: 0 1.4rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        cursor: pointer;
    }

</style>
