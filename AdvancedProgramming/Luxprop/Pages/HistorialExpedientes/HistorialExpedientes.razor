@page "/historial-expedientes"
@using ClosedXML.Excel
@using Luxprop.Data.Models
@using Luxprop.Services
@using Microsoft.EntityFrameworkCore
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@inject LuxpropContext Db
@inject IJSRuntime JS
@inject Luxprop.Services.SessionService Session


<PageTitle>Historial de Expedientes</PageTitle>

<div class="historial-page">
    <div class="page-header">
        <h1>Historial de Expediente</h1>

        <div class="header-actions">

            <select @onchange="OnUserFilterChanged" class="form-select">
                <option value="">-- Todos los usuarios --</option>
                @foreach (var u in usuarios)
                {
                    <option value="@u.UsuarioId">@u.Nombre @u.Apellido</option>
                }
            </select>

            <select @onchange="OnExpedienteFilterChanged" class="form-select">
                <option value="">-- Todos los expedientes --</option>
                @foreach (var id in expedientesIds)
                {
                    <option value="@id">Expediente #@id</option>
                }
            </select>

        </div>
    </div>

    @if (historialFiltrado == null)
    {
        <div class="loading">Cargando historial...</div>
    }
    else if (!historialFiltrado.Any())
    {
        <div class="no-data">No existen registros con los filtros aplicados.</div>
    }
    else
    {
        <button class="btn btn-danger" @onclick="() => ExportHistorialPdf(historialFiltrado)">
            <i class="bi bi-filetype-pdf"></i> Exportar PDF
        </button>

        <button class="btn btn-success" @onclick="() => ExportHistorialExcel(historialFiltrado)">
            <i class="bi bi-file-earmark-excel"></i> Exportar Excel
        </button>


        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Expediente</th>
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th>Estado Nuevo</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in historialFiltrado)
                    {
                        <tr>
                            <td>@h.HistorialId</td>

                            <td>
                                <a href="/expedientes/details/@h.ExpedienteId">
                                    #@h.ExpedienteId
                                </a>
                            </td>

                            <td>@h.Usuario?.Nombre @h.Usuario?.Apellido</td>

                            <td>@h.FechaModificacion.ToString("dd/MM/yyyy HH:mm")</td>

                            <td>@h.Descripcion</td>

                            <td>
                                <span class="badge @(GetEstadoClass(h.EstadoNuevo))">
                                    @h.EstadoNuevo
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<HistorialExpediente>? historial;

    private List<HistorialExpediente>? historialFiltrado;

    private List<Usuario> usuarios = new();
    private List<int> expedientesIds = new();

    private int? filtroUsuarioId = null;
    private int? filtroExpedienteId = null;


    protected override async Task OnInitializedAsync()
    {
        int usuarioId = await Session.GetUserIdAsync();

        await Session.LoadUserAsync();
        var roleRaw = await Session.GetUserRoleAsync();
        var role = NormalizeRole(roleRaw);

        historial = await Db.HistorialExpedientes
            .Include(h => h.Usuario)
            .OrderByDescending(h => h.FechaModificacion)
            .ToListAsync();

        historialFiltrado = historial;

        usuarios = await Db.Usuarios
            .Where(u => historial.Select(h => h.UsuarioId).Contains(u.UsuarioId))
            .ToListAsync();

        expedientesIds = historial
            .Select(h => h.ExpedienteId)
            .Distinct()
            .OrderBy(id => id)
            .ToList();
    }




    private void OnUserFilterChanged(ChangeEventArgs e)
    {
        filtroUsuarioId = string.IsNullOrEmpty(e.Value?.ToString())
            ? null
            : int.Parse(e.Value.ToString());

        ApplyFilters();
    }

    private void OnExpedienteFilterChanged(ChangeEventArgs e)
    {
        filtroExpedienteId = string.IsNullOrEmpty(e.Value?.ToString())
            ? null
            : int.Parse(e.Value.ToString());

        ApplyFilters();
    }

    private void ApplyFilters()
    {
        historialFiltrado = historial;

        if (filtroUsuarioId != null)
            historialFiltrado = historialFiltrado!
                .Where(h => h.UsuarioId == filtroUsuarioId)
                .ToList();

        if (filtroExpedienteId != null)
            historialFiltrado = historialFiltrado!
                .Where(h => h.ExpedienteId == filtroExpedienteId)
                .ToList();

        StateHasChanged();
    }


    public async Task ExportHistorialExcel(List<HistorialExpediente> historial)
    {
        using var wb = new XLWorkbook();
        var ws = wb.Worksheets.Add("Historial");

        ws.Cell(1, 1).Value = "Historial ID";
        ws.Cell(1, 2).Value = "Expediente ID";
        ws.Cell(1, 3).Value = "Usuario";
        ws.Cell(1, 4).Value = "Fecha";
        ws.Cell(1, 5).Value = "Estado";
        ws.Cell(1, 6).Value = "Descripción";

        int row = 2;

        foreach (var h in historial)
        {
            ws.Cell(row, 1).Value = h.HistorialId;
            ws.Cell(row, 2).Value = h.ExpedienteId;
            ws.Cell(row, 3).Value = $"{h.Usuario?.Nombre} {h.Usuario?.Apellido}";
            ws.Cell(row, 4).Value = h.FechaModificacion.ToString("yyyy-MM-dd HH:mm");
            ws.Cell(row, 5).Value = h.EstadoNuevo;
            ws.Cell(row, 6).Value = h.Descripcion;
            row++;
        }

        using var stream = new MemoryStream();
        wb.SaveAs(stream);
        var bytes = stream.ToArray();
        var base64 = Convert.ToBase64String(bytes);

        await JS.InvokeVoidAsync("downloadFile",
            $"Historial_{DateTime.Now:yyyyMMdd}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            base64);
    }


    public async Task ExportHistorialPdf(List<HistorialExpediente> historial)
    {
        var items = historial ?? new List<HistorialExpediente>();

        var pdfBytes = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4);
                page.Margin(20);
                page.DefaultTextStyle(x => x.FontSize(11));

                page.Header().AlignCenter().Text("Historial de Expedientes").FontSize(16).SemiBold();

                page.Content().PaddingVertical(10).Table(table =>
                {
                    table.ColumnsDefinition(columns =>
                    {
                        columns.ConstantColumn(80);   // Historial ID
                        columns.ConstantColumn(80);   // Expediente ID
                        columns.ConstantColumn(80);   // Usuario ID
                        columns.ConstantColumn(130);  // Fecha
                        columns.ConstantColumn(90);   // Estado
                        columns.RelativeColumn();     // Descripción
                    });

                    // Encabezados
                    table.Header(header =>
                    {
                        header.Cell().Element(c => c.Padding(6).Background("#EEEEEE").Text("Historial ID").Bold());
                        header.Cell().Element(c => c.Padding(6).Background("#EEEEEE").Text("Expediente ID").Bold());
                        header.Cell().Element(c => c.Padding(6).Background("#EEEEEE").Text("Usuario ID").Bold());
                        header.Cell().Element(c => c.Padding(6).Background("#EEEEEE").Text("Fecha").Bold());
                        header.Cell().Element(c => c.Padding(6).Background("#EEEEEE").Text("Estado").Bold());
                        header.Cell().Element(c => c.Padding(6).Background("#EEEEEE").Text("Descripción").Bold());
                    });

                    // Filas
                    foreach (var h in items)
                    {
                        table.Cell().Element(c => c.Padding(6).Text(h.HistorialId));
                        table.Cell().Element(c => c.Padding(6).Text(h.ExpedienteId));
                        table.Cell().Element(c => c.Padding(6).Text(h.UsuarioId));
                        table.Cell().Element(c => c.Padding(6).Text(h.FechaModificacion.ToString("yyyy-MM-dd HH:mm")));
                        table.Cell().Element(c => c.Padding(6).Text(h.EstadoNuevo ?? "-"));
                        table.Cell().Element(c => c.Padding(6).Text(h.Descripcion ?? ""));
                    }
                });
            });
        }).GeneratePdf();

        var base64 = Convert.ToBase64String(pdfBytes);

        await JS.InvokeVoidAsync("downloadFile",
            $"Historial_{DateTime.Now:yyyyMMdd}.pdf",
            "application/pdf",
            base64);
    }


    private string GetEstadoClass(string estado) => estado switch
    {
        "Abierto" => "bg-info",
        "En Proceso" => "bg-warning text-dark",
        "Cerrado" => "bg-success",
        _ => "bg-secondary"
    };

    private static string NormalizeRole(string? name)
    {
        var n = name?.Trim().ToLowerInvariant();
        return n switch
        {
            "administrador" or "admin" => "admin",
            "agente" or "agent" => "agent",
            "vendedor" or "seller" => "seller",
            "comprador" or "buyer" or "cliente" => "buyer",
            _ => string.Empty
        };
    }
}

<style>
    .historial-page {
        padding: 2rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        margin-left: auto;
    }
</style>
