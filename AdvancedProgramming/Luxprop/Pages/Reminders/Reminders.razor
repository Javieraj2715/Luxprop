@page "/reminders"
@using Luxprop.Data.Models
@inject IReminderService ReminderSvc
@inject LuxpropContext Db
@inject NavigationManager Nav


<h1>Reminders</h1>

<div class="filters">
  <input type="date" @bind="fromDate" />
  <input type="date" @bind="toDate" />
  <select @bind="filterEstado">
    <option value="">-- Estado --</option>
    <option>Pendiente</option>
    <option>Completado</option>
    <option>Incumplido</option>
  </select>
  <button class="btn btn-primary" @onclick="Load">Apply</button>
  <button class="btn btn-success" @onclick="NewReminder">New</button>
</div>

@if (items is null)
{
  <p>Loading...</p>
}
else
{
  <table class="table">
    <thead>
      <tr>
        <th>Inicio</th><th>Título</th><th>Tipo</th><th>Estado</th><th>Propiedad</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var r in items)
      {
        <tr>
          <td>@r.Inicio.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
          <td>@r.Titulo</td>
          <td>@r.Tipo</td>
          <td>@r.Estado</td>
          <td>@r.PropiedadId</td>
          <td>
            <button class="btn btn-sm btn-outline-success" @onclick='() => SetEstado(r.RecordatorioId, "Completado")'>Done</button>
                        <button class="btn btn-sm btn-primary" @onclick="() => Edit(r.RecordatorioId)">Editar</button>

            <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(r.RecordatorioId)">Delete</button>
          </td>
        </tr>
      }
    </tbody>
  </table>

    <h3>Calendario del mes (@currentMonth.ToString("MMMM yyyy"))</h3>
    @foreach (var group in Days())
    {
        <div class="calendar-day">
            <h5>@group.Key.ToString("dddd, dd MMMM")</h5>
            <ul>
                @foreach (var item in group)
                {
                    <li>@item.Titulo (@item.Inicio.ToShortTimeString())</li>
                }
            </ul>
        </div>
    }

}

@code {
  private List<Recordatorio>? items;
  private DateTime? fromDate = DateTime.Today.AddDays(-7);
  private DateTime? toDate = DateTime.Today.AddDays(21);
  private string? filterEstado;

  protected override async Task OnInitializedAsync() => await Load();

  
  DateTime currentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
  List<Recordatorio> monthItems = new();

  private async Task LoadMonth()
  {
    var start = currentMonth;
    var end = start.AddMonths(1).AddSeconds(-1);
    monthItems = await ReminderSvc.ListAsync(null, start.ToUniversalTime(), end.ToUniversalTime());
  }

  private IEnumerable<IGrouping<DateTime, Recordatorio>> Days()
    => monthItems.GroupBy(r => r.Inicio.Date).OrderBy(g => g.Key);



  private async Task Load()
  {
    items = await ReminderSvc.ListAsync(
      agenteId: null,
      from: fromDate?.ToUniversalTime(),
      to: toDate?.ToUniversalTime());
    if (!string.IsNullOrEmpty(filterEstado))
        items = items!.Where(x => x.Estado == filterEstado).ToList();
  }

  private Task SetEstado(int id, string estado) => ReminderSvc.SetEstadoAsync(id, estado).ContinueWith(_ => Load());
  
  private Task Delete(int id) => ReminderSvc.DeleteAsync(id).ContinueWith(_ => Load());


    private void NewReminder()
    {
        Nav.NavigateTo("/reminders/create");
    }

    private void Edit(int id)
    {
        Nav.NavigateTo($"/reminders/edit/{id}");
    }


}
