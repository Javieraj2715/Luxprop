@page "/chat"
@using Luxprop.Data
@using Luxprop.Data.Models
@inject LuxpropContext Db
@inject Luxprop.Services.SessionService Session
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Marty LiveChat</PageTitle>

<div class="client-chat-page">

    @if (!isChatActive)
    {
        <!-- PANTALLA INICIAL -->
        <div class="start-box">
            <img src="/img/marty.png" class="start-avatar" />
            <h2>Start chatting with Marty</h2>
            <p>Your virtual assistant is ready to help.</p>

            <button class="start-btn" @onclick="StartChat">
                Start Chat
            </button>
        </div>
    }
    else
    {
        <!-- HEADER -->
        <div class="client-chat-header">
            <div class="header-left">
                <div class="header-avatar">
                    <img src="/img/marty.png" />
                </div>

                <div>
                    <h3>Marty</h3>
                    <p class="online-status">
                        <span class="online-dot"></span> Virtual assistant
                    </p>
                </div>
            </div>
        </div>

        <!-- MENSAJES -->
        <div class="client-messages" @ref="messagesContainer">
            @foreach (var msg in messages)
            {
                var sender = msg.Sender.ToLower();

                <div class="msg-row @sender">
                    @if (sender == "bot")
                    {
                        <div class="msg-avatar bot-avatar-sm">
                            <img src="/img/marty.png" />
                        </div>
                    }

                    <div class="msg-bubble @sender">@msg.Text</div>

                    @if (sender == "client")
                    {
                        <div class="msg-avatar client-avatar">
                            @userName?.FirstOrDefault()
                        </div>
                    }
                </div>
            }
        </div>

        <!-- INPUT -->
        <EditForm Model="@newMessage" OnValidSubmit="@SendMessage">
            <div class="client-input-box">
                <InputText @bind-Value="newMessage.Text"
                           class="client-input"
                           placeholder="Type your message..."
                           autocomplete="off" />

                <button class="client-send-btn"
                        disabled="@string.IsNullOrWhiteSpace(newMessage.Text)">
                    Send
                </button>
            </div>
        </EditForm>
    }

</div>

@code {
    private bool isChatActive = false;
    private bool waitingForAgent = false;
    private bool isBotActive = true;

    private List<ChatMessage> messages = new();
    private ChatMessage newMessage = new();
    private int currentThreadId = 0;
    private ElementReference messagesContainer;

    private bool keepPolling = true;

    private string? userName;
    private string? userEmail;
    private int userId;

    protected override async Task OnInitializedAsync()
    {
        await Session.LoadUserAsync();

        if (!Session.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        userName = await Session.GetUserNameAsync();
        userEmail = await Session.GetUserEmailAsync();
        userId = await Session.GetUserIdAsync();

        if (string.IsNullOrEmpty(userEmail))
        {
            userEmail = Db.Usuarios
                .Where(u => u.UsuarioId == userId)
                .Select(u => u.Email)
                .FirstOrDefault() ?? "unknown@2crre.com";
        }

        await LoadOrCreateThread();
    }

    private async Task LoadOrCreateThread()
    {
        var thread = Db.ChatThreads
            .Where(t => t.ClientEmail == userEmail)
            .OrderByDescending(t => t.CreatedUtc)
            .FirstOrDefault();

        if (thread == null || thread.State == "Closed")
        {
            thread = new ChatThread
            {
                State = "Open",
                ClientName = userName ?? "User",
                ClientEmail = userEmail,
                CreatedUtc = DateTime.UtcNow,
                CreatedByUserId = userId,
                NeedsAgent = false
            };

            Db.ChatThreads.Add(thread);
            await Db.SaveChangesAsync();

            await AddBotMessage(thread.ChatThreadId, $"Hi {userName}! ðŸ‘‹ I'm Marty, your virtual assistant.");
            await AddBotMessage(thread.ChatThreadId, GetMainMenu());
        }

        currentThreadId = thread.ChatThreadId;
        isChatActive = true;
        waitingForAgent = thread.NeedsAgent;
        isBotActive = !waitingForAgent;

        await LoadMessages();
        await StartPolling();
    }

    private async Task StartChat() => await LoadOrCreateThread();

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage.Text)) return;

        var msg = new ChatMessage
        {
            ChatThreadId = currentThreadId,
            Sender = "Client",
            Text = newMessage.Text.Trim(),
            SentUtc = DateTime.UtcNow,
            UsuarioId = userId
        };

        Db.ChatMessages.Add(msg);
        await Db.SaveChangesAsync();

        newMessage.Text = string.Empty;

        await LoadMessages();
        await ScrollToBottom();

        if (waitingForAgent)
        {
            await AddBotMessage(currentThreadId,
                "An agent will be with you shortly ðŸ˜„ please hang tight...");
            await LoadMessages();
            await ScrollToBottom();
            return;
        }

        if (isBotActive)
            await ProcessBotResponse(msg.Text);
    }

    private async Task ProcessBotResponse(string input)
    {
        var response = GetBotResponse(input);

        if (response.Contains("agent"))
        {
            isBotActive = false;
            waitingForAgent = true;

            var thread = Db.ChatThreads.Find(currentThreadId);
            if (thread != null)
            {
                thread.NeedsAgent = true;
                await Db.SaveChangesAsync();
            }
        }

        await AddBotMessage(currentThreadId, response);
        await LoadMessages();
        await ScrollToBottom();
    }

    private async Task AddBotMessage(int threadId, string text)
    {
        var botMsg = new ChatMessage
        {
            ChatThreadId = threadId,
            Sender = "Bot",
            Text = text,
            SentUtc = DateTime.UtcNow
        };

        Db.ChatMessages.Add(botMsg);
        await Db.SaveChangesAsync();
    }

    private async Task LoadMessages()
    {
        messages = Db.ChatMessages
            .Where(m => m.ChatThreadId == currentThreadId)
            .OrderBy(m => m.ChatMessageId)
            .ToList();

        await InvokeAsync(StateHasChanged);
    }

    private async Task StartPolling()
    {
        keepPolling = true;

        while (keepPolling)
        {
            await PollForNewMessages();
            await Task.Delay(3000);
        }
    }

    private async Task PollForNewMessages()
    {
        var lastId = messages.LastOrDefault()?.ChatMessageId ?? 0;
        var newMsgs = Db.ChatMessages
            .Where(m => m.ChatThreadId == currentThreadId && m.ChatMessageId > lastId)
            .OrderBy(m => m.ChatMessageId)
            .ToList();

        if (newMsgs.Any())
        {
            messages.AddRange(newMsgs);
            await InvokeAsync(StateHasChanged);
            await ScrollToBottom();

            if (newMsgs.Any(m => m.Sender == "Agent"))
            {
                waitingForAgent = false;
                isBotActive = false;
            }
        }
    }

    private async Task ScrollToBottom()
    {
        try { await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); }
        catch { }
    }

    private string GetMainMenu()
    {
        return "Please choose an option:\n" +
               "1ï¸âƒ£ Plans & pricing\n" +
               "2ï¸âƒ£ Documentation\n" +
               "3ï¸âƒ£ Working hours & contact info\n" +
               "4ï¸âƒ£ Talk to a human agent ðŸ‘©â€ðŸ’¼\n" +
               "0ï¸âƒ£ Back to main menu";
    }

    private string GetBotResponse(string input)
    {
        var q = (input ?? "").Trim().ToLowerInvariant();

        if (q == "0") return GetMainMenu();

        if (q == "4" || q.Contains("agent") || q.Contains("support"))
            return "Got it ðŸ‘ Iâ€™ll connect you with one of our agents shortly.";

        if (q == "1" || q.Contains("price") || q.Contains("plan"))
            return "We offer three plans: Basic ($29), Pro ($79), and Enterprise (custom pricing). Type 0 to go back.";

        if (q == "2" || q.Contains("doc") || q.Contains("guide"))
            return "You can find our documentation under the Help Center. Type 0 to go back.";

        if (q == "3" || q.Contains("contact") || q.Contains("hours") || q.Contains("email"))
            return "Our working hours are Monâ€“Fri, 9amâ€“6pm (GMT-6). Email: support@2crre.com ðŸ“§";

        return "I didnâ€™t quite get that ðŸ¤”\n" + GetMainMenu();
    }

    public void Dispose() => keepPolling = false;
}

<style>

    :root {
        --primary: #05445E;
        --accent: #4CB9B0;
        --bg-light: #F5F8FB;
        --bot-bg: #EAF6F6;
    }

    .client-chat-page {
        width: 100%;
        max-width: 900px;
        margin: 2rem auto;
        padding: 1rem;
        border-radius: 18px;
        min-height: 85vh;
        background: white;
        box-shadow: 0 18px 35px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
    }

    /* START BOX */
    .start-box {
        margin: auto;
        text-align: center;
    }

    .start-avatar {
        width: 95px;
        height: 95px;
        margin-bottom: 1rem;
    }

    .start-btn {
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border: none;
        padding: 0.75rem 1.8rem;
        border-radius: 12px;
        font-size: 1rem;
        color: white;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }

    .client-chat-header {
        display: flex;
        align-items: center;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        padding: 1rem;
        border-radius: 12px;
        color: white;
        margin-bottom: 1rem;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .header-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        overflow: hidden;
        background: white;
        border: 3px solid var(--accent);
    }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .online-status {
        font-size: 0.8rem;
        opacity: 0.9;
    }

    .online-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        display: inline-block;
        border-radius: 50%;
    }

    /* MESSAGES */
    .client-messages {
        flex: 1;
        background: var(--bg-light);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
    }

    .msg-row {
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

        .msg-row.client {
            justify-content: flex-end;
        }

    .msg-avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        overflow: hidden;
    }

    .bot-avatar-sm img {
        width: 100%;
        height: 100%;
    }

    .client-avatar {
        background: #4CB9B033;
        color: var(--primary);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .msg-bubble {
        max-width: 70%;
        padding: 0.9rem 1.1rem;
        border-radius: 14px;
        font-size: 0.95rem;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

        .msg-bubble.bot {
            background: var(--bot-bg);
            border-left: 4px solid var(--accent);
        }

        .msg-bubble.client {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
        }

    /* INPUT */
    .client-input-box {
        display: flex;
        background: white;
        border-radius: 14px;
        padding: 0.5rem;
        margin-top: 1rem;
        gap: 0.5rem;
        box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }

    .client-input {
        flex: 1;
        border: none;
        background: #F0F4F8;
        padding: 0.8rem;
        border-radius: 10px;
    }

    .client-send-btn {
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border: none;
        padding: 0 1.4rem;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        cursor: pointer;
    }

</style>
