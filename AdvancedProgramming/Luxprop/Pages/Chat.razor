@page "/chat"
@using Luxprop.Data
@using Luxprop.Data.Models
@using Luxprop.Services
@inject LuxpropContext Db
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject SessionService SessionService

<PageTitle>Chat - Luxprop</PageTitle>

<div class="chat-page">
    <div class="page-header">
        <h1>@(userRole == "Client" ? "Support Chat" : "Agent Dashboard")</h1>

        <div class="chat-controls">
            @if (currentThreadId > 0)
            {
                <button class="btn btn-outline-danger" @onclick="CloseThread">Close Chat</button>
            }
            else if (userRole == "Client")
            {
                <button class="btn btn-primary" @onclick="StartNewChat">Start New Chat</button>
            }
        </div>
    </div>

    @if (userRole == "Client")
    {
        <!-- Client view -->
        <div class="chat-container">
            <div class="chat-messages" @ref="messagesContainer">
                @if (messages?.Any() == true)
                {
                    @foreach (var m in messages.OrderBy(m => m.SentUtc))
                    {
                        <div class="message @(m.Sender.ToLower().Contains("marty") ? "bot" : "client")">
                            <div class="bubble">
                                <div class="sender">@m.Sender</div>
                                <div class="text">@m.Text</div>
                                <div class="time">@m.SentUtc.ToString("HH:mm")</div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="no-messages">Start your conversation below.</div>
                }
            </div>

            @if (chatClosed)
            {
                <div class="chat-closed-msg">This chat was closed. You can start a new one anytime.</div>
                <button class="btn btn-success w-100 mt-2" @onclick="StartNewChat">Start New Chat</button>
            }
            else
            {
                <div class="chat-input">
                    <EditForm Model="@newMessage" OnValidSubmit="@SendMessage">
                        <div class="input-group">
                            <InputText @bind-Value="newMessage.Text" class="form-control" placeholder="Type your message..." />
                            <button type="submit" class="btn btn-primary" disabled="@string.IsNullOrWhiteSpace(newMessage.Text)">Send</button>
                        </div>
                    </EditForm>
                </div>
            }
        </div>
    }
    else if (userRole == "Agent" || userRole == "Admin")
    {
        <!-- Agent view -->
        <div class="agent-panel">
            <div class="thread-list">
                <h4>Active Chats</h4>
                @if (threads?.Any() == true)
                {
                    @foreach (var t in threads.OrderByDescending(t => t.CreatedUtc))
                    {
                        <div class="thread-item @(t.ChatThreadId == currentThreadId ? "active" : "")" @onclick="() => LoadThread(t.ChatThreadId)">
                            <div class="thread-info">
                                <strong>@t.ClientName</strong>
                                <small>@t.CreatedUtc.ToLocalTime().ToString("dd/MM HH:mm")</small>
                            </div>
                            <span class="badge @(t.NeedsAgent ? "pending" : "ok")">@t.State</span>
                        </div>
                    }
                }
                else
                {
                    <p class="no-threads">No active chats at the moment.</p>
                }
            </div>

            <div class="agent-chat">
                @if (messages?.Any() == true)
                {
                    <div class="chat-messages" @ref="messagesContainer">
                        @foreach (var m in messages.OrderBy(m => m.SentUtc))
                        {
                            <div class="message @(m.Sender.ToLower().Contains("marty") ? "bot" : m.Sender == "Agent" ? "agent" : "client")">
                                <div class="bubble">
                                    <div class="sender">@m.Sender</div>
                                    <div class="text">@m.Text</div>
                                    <div class="time">@m.SentUtc.ToString("HH:mm")</div>
                                </div>
                            </div>
                        }
                    </div>

                    <EditForm Model="@newMessage" OnValidSubmit="@SendMessage">
                        <div class="input-group mt-2">
                            <InputText @bind-Value="newMessage.Text" class="form-control" placeholder="Write a reply..." />
                            <button type="submit" class="btn btn-primary" disabled="@string.IsNullOrWhiteSpace(newMessage.Text)">Send</button>
                        </div>
                    </EditForm>
                }
                else
                {
                    <div class="no-chat">Select a chat from the list.</div>
                }
            </div>
        </div>
    }
</div>

@code {
    private int currentThreadId;
    private int codUsuario;
    private string? userName;
    private string? userRole;
    private bool chatClosed = false;
    private List<ChatMessage>? messages;
    private List<ChatThread>? threads;
    private ChatMessage newMessage = new();
    private ElementReference messagesContainer;
    private Timer? pollTimer;

    protected override async Task OnInitializedAsync()
    {
        var userIdStr = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "UserId");
        userName = await SessionService.GetUserNameAsync();
        userRole = await SessionService.GetUserRoleAsync();

        // Normalize roles
        userRole = userRole?.Trim().ToLower() switch
        {
            "cliente" or "client" => "Client",
            "agente" or "agent" or "admin" => "Agent",
            _ => "Client"
        };

        if (string.IsNullOrEmpty(userName) || !int.TryParse(userIdStr, out codUsuario))
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        if (userRole == "Client") await InitializeChat();
        else if (userRole == "Agent")
        {
            threads = Db.ChatThreads.Where(t => t.State == "Open").ToList();
            StartPollingThreads();
        }
    }

    private async Task InitializeChat()
    {
        var thread = Db.ChatThreads.FirstOrDefault(t => t.State == "Open" && t.CreatedByUserId == codUsuario);

        if (thread == null)
        {
            thread = new ChatThread
            {
                ClientName = userName,
                CreatedByUserId = codUsuario,
                State = "Open",
                CreatedUtc = DateTime.UtcNow,
                NeedsAgent = false
            };

            Db.ChatThreads.Add(thread);
            await Db.SaveChangesAsync();
            await AddBotMessage(thread.ChatThreadId, $"Welcome {userName}! I'm Marty, your Luxprop assistant.");
            await AddBotMessage(thread.ChatThreadId, GetMainMenu());
        }

        currentThreadId = thread.ChatThreadId;
        chatClosed = thread.State == "Closed";
        await LoadMessages();
        StartPollingMessages();
    }

    private async Task LoadThread(int id)
    {
        currentThreadId = id;
        await LoadMessages();
        StartPollingMessages();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage.Text) || currentThreadId <= 0) return;

        var sender = userRole == "Client" ? userName : "Agent";

        var msg = new ChatMessage
        {
            ChatThreadId = currentThreadId,
            Text = newMessage.Text.Trim(),
            Sender = sender!,
            UsuarioId = codUsuario,
            SentUtc = DateTime.UtcNow
        };

        Db.ChatMessages.Add(msg);

        var thread = Db.ChatThreads.Find(currentThreadId);
        if (thread != null)
        {
            if (userRole == "Client") thread.NeedsAgent = true;
            else thread.NeedsAgent = false;
        }

        await Db.SaveChangesAsync();
        newMessage.Text = string.Empty;

        // Bot only responds if not yet handled by a human agent
        if (userRole == "Client" && thread?.NeedsAgent == false)
            await ProcessBotResponse(msg.Text);

        await LoadMessages();
        await ScrollToBottom();
    }

    private async Task ProcessBotResponse(string userInput)
    {
        var q = (userInput ?? "").Trim().ToLowerInvariant();
        string response;
        bool connectAgent = false;

        if (q == "0") response = GetMainMenu();
        else if (q == "1" || q.Contains("plan") || q.Contains("price"))
            response = "We offer three plans: Basic ($29), Pro ($79) and Enterprise (custom pricing).";
        else if (q == "2" || q.Contains("doc"))
            response = "You can access our documentation through the Luxprop Help Center.";
        else if (q == "3" || q.Contains("contact"))
            response = "Our support team is available Monday–Friday, 9am–6pm (GMT-6). support@luxprop.com | +506 4000-0000";
        else if (q == "9" || q.Contains("agent") || q.Contains("human"))
        {
            response = "Our support team will contact you shortly. Please wait a moment.";
            connectAgent = true;
        }
        else response = "I didn’t understand that. Please try again.\n" + GetMainMenu();

        await AddBotMessage(currentThreadId, response);

        if (connectAgent)
        {
            var thread = Db.ChatThreads.Find(currentThreadId);
            if (thread != null)
            {
                thread.NeedsAgent = true;
                await Db.SaveChangesAsync();
            }
        }

        await LoadMessages();
        await ScrollToBottom();
    }

    private async Task AddBotMessage(int threadId, string text)
    {
        var bot = new ChatMessage
        {
            ChatThreadId = threadId,
            Text = text,
            Sender = "Marty",
            SentUtc = DateTime.UtcNow
        };
        Db.ChatMessages.Add(bot);
        await Db.SaveChangesAsync();
    }

    private string GetMainMenu() =>
        "Choose an option:\n1 - Plans and Pricing\n2 - Documentation\n3 - Contact Information\n9 - Talk to an Agent\n0 - Main Menu";

    private async Task LoadMessages()
    {
        messages = Db.ChatMessages
            .Where(m => m.ChatThreadId == currentThreadId)
            .OrderBy(m => m.SentUtc)
            .ToList();
        await InvokeAsync(StateHasChanged);
    }

    private void StartPollingMessages()
    {
        pollTimer?.Dispose();
        pollTimer = new Timer(async _ => await PollForNewMessages(), null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
    }

    private void StartPollingThreads()
    {
        pollTimer?.Dispose();
        pollTimer = new Timer(async _ => await PollForNewThreads(), null, TimeSpan.Zero, TimeSpan.FromSeconds(3));
    }

    private async Task PollForNewMessages()
    {
        if (currentThreadId <= 0) return;
        await LoadMessages();
        await InvokeAsync(StateHasChanged);
    }

    private async Task PollForNewThreads()
    {
        threads = Db.ChatThreads.Where(t => t.State == "Open").OrderByDescending(t => t.CreatedUtc).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseThread()
    {
        var thread = Db.ChatThreads.Find(currentThreadId);
        if (thread == null) return;

        thread.State = "Closed";
        thread.NeedsAgent = false;
        thread.ClosedUtc = DateTime.UtcNow;
        await Db.SaveChangesAsync();

        await AddBotMessage(thread.ChatThreadId, "This chat has been closed. Thank you for contacting Luxprop.");

        chatClosed = true;
        messages = null;
        currentThreadId = 0;
        StopPolling();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ScrollToBottom()
    {
        try { await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
    }

    private void StopPolling()
    {
        pollTimer?.Dispose();
        pollTimer = null;
    }

    private async Task StartNewChat()
    {
        await CloseThread();
        chatClosed = false;
        await InitializeChat();
    }
}

<style>
    .chat-page {
        padding: 2rem;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f6f9fb, #eef3f6);
        font-family: 'Poppins', sans-serif;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #0d505a;
        margin-bottom: 1rem;
    }

        .page-header h1 {
            color: #0d505a;
            font-weight: 600;
        }

    .chat-container, .agent-panel {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        border-radius: 10px;
        background-color: #fafcfd;
    }

    .message {
        display: flex;
        margin-bottom: 10px;
    }

        .message.client {
            justify-content: flex-end;
        }

        .message.bot, .message.agent {
            justify-content: flex-start;
        }

    .bubble {
        background: #0d505a;
        color: #fff;
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 70%;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    .message.bot .bubble {
        background: #e9eef1;
        color: #333;
    }

    .sender {
        font-weight: 600;
        font-size: 0.8rem;
    }

    .time {
        font-size: 0.7rem;
        text-align: right;
        margin-top: 4px;
        opacity: 0.7;
    }

    .input-group {
        display: flex;
    }

    .form-control {
        flex: 1;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 10px;
    }

    .btn {
        border-radius: 8px;
    }

    .thread-list {
        width: 30%;
        border-right: 1px solid #ddd;
        padding-right: 1rem;
        overflow-y: auto;
    }

    .agent-chat {
        flex: 1;
        padding-left: 1rem;
    }

    .thread-item {
        padding: 0.7rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        background-color: #f1f6f8;
        transition: 0.2s;
    }

        .thread-item.active {
            background-color: #0d505a;
            color: white;
        }

        .thread-item:hover {
            background-color: #cde3e9;
        }

    .badge {
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
    }

        .badge.pending {
            background: #ffc107;
            color: #333;
        }

        .badge.ok {
            background: #198754;
            color: white;
        }

    .no-messages, .no-chat, .no-threads {
        text-align: center;
        color: #777;
        padding: 1rem;
    }

    .chat-closed-msg {
        text-align: center;
        color: #0d505a;
        font-weight: 600;
    }
</style>
