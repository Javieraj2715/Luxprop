@page "/expedientes/edit/{ExpedienteId:int}"
@using Luxprop.Data.Models
@using Microsoft.EntityFrameworkCore
@inject LuxpropContext Db
@inject NavigationManager Navigation
@inject Luxprop.Services.SessionService Session

<h3 class="mb-3">Edit Case File</h3>

@if (expediente == null)
{
    <div class="alert alert-warning">Case file not found.</div>
}
else
{
    <EditForm Model="expediente" OnValidSubmit="GuardarCambios">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Case Info -->
        <div class="card p-4 shadow-sm mb-4">
            <h5 class="fw-bold text-primary">Case File Information</h5>
            <hr />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Type of Occupation</label>
                    <InputText class="form-control" @bind-Value="expediente.TipoOcupacion" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <InputSelect class="form-select" @bind-Value="expediente.Estado">
                        <option value="Abierto">Open</option>
                        <option value="En proceso">In Progress</option>
                        <option value="Cerrado">Closed</option>
                    </InputSelect>
                </div>
            </div>

            @if (expediente.Estado == "Cerrado")
            {
                <div class="mb-3">
                    <label class="form-label">Closing Date</label>
                    <InputDate class="form-control" @bind-Value="expediente.FechaCierre" />
                </div>
            }

            <label class="form-label">Description (History Log):</label>
            <InputTextArea class="form-control" rows="3" @bind-Value="descripcionHistorial" />

            <div class="card p-4 shadow-sm mb-4"></div>
            <!-- DOCUMENTS -->
            <div class="card p-4 shadow-sm mb-4">
                <h5 class="fw-bold text-primary">Documents</h5>
                <hr />

                <InputFile OnChange="GuardarArchivoTemporal" class="form-control mb-2" />

                @if (!string.IsNullOrEmpty(nombreArchivoTemporal))
                {
                    <small class="text-success">File ready to upload: @nombreArchivoTemporal (will be saved on Save Changes)</small>
                }

                @if (documentos != null && documentos.Any())
                {
                    <table class="table table-striped mt-3">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th style="width:120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in documentos)
                            {
                                <tr>
                                    <td>@d.Nombre</td>
                                    <td>@d.FechaCarga?.ToString("yyyy-MM-dd")</td>
                                    <td>@d.Estado</td>
                                    <td>
                                        <a href="@($"/uploads/{d.Nombre}")" download class="btn btn-sm btn-outline-primary">Download</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>No documents uploaded yet.</p>
                }
            </div>

            <div class="mt-3 text-end">
                <button class="btn btn-primary me-2">Save Changes</button>
                <button type="button" class="btn btn-secondary" @onclick="Volver">Cancel</button>
            </div>
        </div>

    </EditForm>

    <!-- TASKS -->
    <div class="card p-4 shadow-sm mb-4">
        <h5 class="fw-bold text-primary">Process Tasks</h5>
        <hr />

        <EditForm Model="nuevaTarea" OnValidSubmit="AgregarTarea">
            <div class="row g-2 mb-3">
                <div class="col-md-5">
                    <InputText class="form-control" @bind-Value="nuevaTarea.Titulo" placeholder="Task Title" />
                </div>
                <div class="col-md-5">
                    <InputText class="form-control" @bind-Value="nuevaTarea.Estado" placeholder="Status (Pending, Done…)" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100">Add</button>
                </div>
            </div>
        </EditForm>

        @if (tareas != null && tareas.Any())
        {
            <table class="table table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th style="width:100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in tareas)
                    {
                        <tr>
                            <td>@t.Titulo</td>
                            <td>@t.Estado</td>
                            <td>
                                <button class="btn btn-sm btn-danger" @onclick="() => EliminarTarea(t.TareaId)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No tasks registered.</p>
        }
    </div>

    <!-- HISTORY -->
    <div class="card p-4 shadow-sm">
        <h5 class="fw-bold text-primary">History Log</h5>
        <hr />

        @if (historial != null && historial.Any())
        {
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in historial)
                    {
                        <tr>
                            <td>@h.FechaModificacion</td>
                            <td>@h.EstadoNuevo</td>
                            <td>@h.Descripcion</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No history yet.</p>
        }
    </div>
}

@code {
    [Parameter] public int ExpedienteId { get; set; }
    private Expediente? expediente;
    private List<Documento>? documentos;
    private List<HistorialExpediente>? historial;
    private List<TareaTramite>? tareas;

    private string descripcionHistorial = "";
    private TareaTramite nuevaTarea = new();
    private IBrowserFile? archivoTemporal;
    private string? nombreArchivoTemporal;

    protected override async Task OnInitializedAsync()
    {
        expediente = await Db.Expedientes
            .Include(e => e.Cliente).ThenInclude(c => c.Usuario)
            .Include(e => e.Documentos)
            .FirstOrDefaultAsync(e => e.ExpedienteId == ExpedienteId);

        documentos = expediente?.Documentos.ToList();

        tareas = await Db.TareaTramites.Where(t => t.ExpedienteId == ExpedienteId).ToListAsync();

        historial = await Db.HistorialExpedientes.Where(h => h.ExpedienteId == ExpedienteId)
                                                 .OrderByDescending(h => h.FechaModificacion)
                                                 .ToListAsync();
    }

    private void GuardarArchivoTemporal(InputFileChangeEventArgs e)
    {
        archivoTemporal = e.File;
        nombreArchivoTemporal = archivoTemporal.Name;
    }

    private async Task GuardarCambios()
    {

        int usuarioId = await Session.GetUserIdAsync();


        if (expediente != null)
        {
            expediente.UltimaActualizacion = DateTime.Now;
        }

        // Save expediente
        Db.Expedientes.Update(expediente!);

        // Save history
        Db.HistorialExpedientes.Add(new HistorialExpediente
        {
            ExpedienteId = expediente!.ExpedienteId,
            UsuarioId = usuarioId,
            FechaModificacion = DateTime.Now,
            EstadoNuevo = expediente.Estado,
            Descripcion = string.IsNullOrWhiteSpace(descripcionHistorial) ? "Case updated." : descripcionHistorial
        });

        // Save document if exists
        if (archivoTemporal != null)
        {
            var uploadsPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads");
            if (!Directory.Exists(uploadsPath))
                Directory.CreateDirectory(uploadsPath);

            var filePath = Path.Combine(uploadsPath, archivoTemporal.Name);

            using var stream = new FileStream(filePath, FileMode.Create);
            await archivoTemporal.OpenReadStream(10_000_000).CopyToAsync(stream);

            Db.Documentos.Add(new Documento
            {
                Nombre = archivoTemporal.Name,
                TipoDocumento = archivoTemporal.ContentType,
                FechaCarga = DateOnly.FromDateTime(DateTime.Now),
                Estado = "Activo",
                ExpedienteId = expediente.ExpedienteId
            });
        }

        await Db.SaveChangesAsync();
        Navigation.NavigateTo($"/expedientes/details/{expediente.ExpedienteId}");
    }

    private async Task AgregarTarea()
    {
        nuevaTarea.ExpedienteId = ExpedienteId;
        nuevaTarea.FechaInicio = DateTime.Now;

        Db.TareaTramites.Add(nuevaTarea);
        await Db.SaveChangesAsync();

        tareas = await Db.TareaTramites.Where(t => t.ExpedienteId == ExpedienteId).ToListAsync();
        nuevaTarea = new();
    }

    private async Task EliminarTarea(int id)
    {
        var tarea = await Db.TareaTramites.FindAsync(id);
        if (tarea != null)
        {
            Db.TareaTramites.Remove(tarea);
            await Db.SaveChangesAsync();
            tareas = await Db.TareaTramites.Where(t => t.ExpedienteId == ExpedienteId).ToListAsync();
        }
    }

    private void Volver() => Navigation.NavigateTo("/expedientes");
}
