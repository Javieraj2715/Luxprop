@page "/expedientes"
@using Luxprop.Data.Models
@using Luxprop.Business.Services
@inject IExpedienteService ExpedienteService
@inject NavigationManager Navigation
@inject Luxprop.Services.SessionService Session
@inject IJSRuntime JS

<PageTitle>Expedientes - Luxprop</PageTitle>

<div class="expedientes-page">

    <!-- Filtros -->
    <div class="filters mb-4 d-flex flex-wrap gap-2">
        <select class="form-select w-auto" @bind="filtroEstado">
            <option value="">Filtrar por Estado</option>
            <option>Abierto</option>
            <option>En proceso</option>
            <option>Cerrado</option>
        </select>

        <input type="text" class="form-control w-auto" placeholder="Buscar por propiedad" @bind="filtroPropiedad" />
        <input type="text" class="form-control w-auto" placeholder="Buscar por cliente" @bind="filtroCliente" />

        <button class="btn btn-export" @onclick="ExportarPDF">Exportar a PDF</button>
        <button class="btn btn-export" @onclick="ExportarExcel">Exportar a Excel</button>
    </div>

    @if (expedientes == null)
    {
        <div class="text-muted mt-4">Cargando expedientes...</div>
    }
    else if (!expedientes.Any())
    {
        <div class="text-muted mt-4">No hay expedientes registrados.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Propiedad</th>
                        <th>Cliente</th>
                        <th>Agente</th>
                        <th>Estado</th>
                        <th>Fecha Apertura</th>
                        <th>Última Actualización</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in expedientesFiltrados)
                    {
                        <tr>
                            <!-- Propiedad -->
                            <td>@e.Propiedad?.Titulo</td>

                            <!-- Cliente -->
                            <td>
                                @($"{e.Cliente?.Usuario?.Nombre} {e.Cliente?.Usuario?.Apellido}")
                            </td>

                            <!-- Agente -->
                            <td>
                                @($"{e.Agente?.Nombre} {e.Agente?.Apellido}")
                            </td>

                            <!-- Estado -->
                            <td>
                                <span class="badge @(GetBadgeClass(e.Estado))">@e.Estado</span>
                            </td>

                            <!-- Fecha apertura -->
                            <td>@e.FechaApertura?.ToString("yyyy-MM-dd")</td>

                            <!-- Última actualización -->
                            <td>@e.UltimaActualizacion?.ToString("yyyy-MM-dd")</td>

                            <!-- Acciones -->
                            <td>
                                <div class="action-buttons d-flex gap-1">

                                    <!-- Botón Ver (verde con borde grueso) -->
                                    <a href="/expedientes/details/@e.ExpedienteId"
                                       class="btn btn-sm btn-outline-success ver-btn">
                                        <i class="bi bi-eye"></i> Ver
                                    </a>

                                    <!-- Botón Eliminar -->
                                    <button class="btn btn-sm btn-outline-danger"
                                            @onclick="() => ConfirmDelete(e.ExpedienteId)">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>

                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Expediente>? expedientes;
    private string filtroEstado = "";
    private string filtroPropiedad = "";
    private string filtroCliente = "";

    // ✅ Aplica filtros con null-safe para cliente
    private IEnumerable<Expediente> expedientesFiltrados =>
        expedientes?
            .Where(e =>
                (string.IsNullOrEmpty(filtroEstado) || e.Estado == filtroEstado) &&
                (string.IsNullOrEmpty(filtroPropiedad) ||
                    (e.Propiedad?.Titulo?.Contains(filtroPropiedad, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                (string.IsNullOrEmpty(filtroCliente) ||
                    ($"{e.Cliente?.Usuario?.Nombre} {e.Cliente?.Usuario?.Apellido}"
                        .Contains(filtroCliente, StringComparison.OrdinalIgnoreCase)))
            ) ?? Enumerable.Empty<Expediente>();

    protected override async Task OnInitializedAsync()
    {
        await LoadExpedientes();
    }

    // ✅ Carga expedientes respetando el rol (admin / agente)
    private async Task LoadExpedientes()
    {
        await Session.LoadUserAsync();
        int usuarioId = await Session.GetUserIdAsync();
        var roleRaw = await Session.GetUserRoleAsync();
        var role = NormalizeRole(roleRaw);

        var allExpedientes = await ExpedienteService.GetAllAsync();

        if (role == "agent")
        {
            expedientes = allExpedientes
                .Where(e => e.AgenteId == usuarioId)
                .ToList();
        }
        else
        {
            expedientes = allExpedientes.ToList();
        }
    }

    private string GetBadgeClass(string estado) => estado switch
    {
        "Abierto" => "bg-warning text-dark",
        "En proceso" => "bg-info text-dark",
        "Cerrado" => "bg-success",
        _ => "bg-secondary"
    };

    private void VerDetalles(int id) =>
        Navigation.NavigateTo($"/expedientes/details/{id}");

    private void ExportarPDF() => Console.WriteLine("Exportar PDF");
    private void ExportarExcel() => Console.WriteLine("Exportar Excel");

    private static string NormalizeRole(string? name)
    {
        var n = name?.Trim().ToLowerInvariant();
        return n switch
        {
            "administrador" or "admin" => "admin",
            "agente" or "agent" => "agent",
            "vendedor" or "seller" => "seller",
            "comprador" or "buyer" or "cliente" => "buyer",
            _ => string.Empty
        };
    }

    // ✅ Confirmación + borrado + recarga
    private async Task ConfirmDelete(int id)
    {
        bool confirm = await JS.InvokeAsync<bool>(
            "confirm",
            "¿Seguro que deseas eliminar este expediente? Esta acción no se puede deshacer.");

        if (!confirm)
            return;

        try
        {
            var ok = await ExpedienteService.DeleteAsync(id);

            if (!ok)
            {
                await JS.InvokeVoidAsync("alert", "No se pudo eliminar el expediente (no existe o falló la operación).");
                return;
            }

            await LoadExpedientes();  // recargar la lista desde BD
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error deleting expediente: " + ex.Message);
            await JS.InvokeVoidAsync("alert", "Ocurrió un error al eliminar el expediente. Revisa la consola.");
        }
    }
}

<style>
    .ver-btn {
        border: 2px solid #28a745 !important;
        color: #28a745 !important;
        font-weight: 600;
    }

        .ver-btn:hover {
            background-color: #28a745 !important;
            color: white !important;
        }
</style>
