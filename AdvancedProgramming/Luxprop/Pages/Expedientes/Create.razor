@page "/expedientes/create/{PropiedadId:int}"
@using Luxprop.Data.Models
@using Microsoft.EntityFrameworkCore
@inject LuxpropContext Db
@inject NavigationManager Navigation

<h3>Crear Expediente</h3>

<EditForm Model="nuevoExpediente" OnValidSubmit="GuardarExpediente">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Tipo de Ocupación</label>
        <InputText class="form-control" @bind-Value="nuevoExpediente.TipoOcupacion" />
    </div>

    <div class="mb-3">
        <label class="form-label">Estado</label>
        <InputSelect class="form-select" @bind-Value="nuevoExpediente.Estado">
            <option value="Abierto">Abierto</option>
            <option value="En proceso">En proceso</option>
            <option value="Cerrado">Cerrado</option>
        </InputSelect>
    </div>

    <button type="submit" class="btn btn-success">✅ Crear Expediente</button>
    <button type="button" class="btn btn-secondary" @onclick="Volver">Cancelar</button>
</EditForm>

@code {
    [Parameter] public int PropiedadId { get; set; }

    private Expediente nuevoExpediente = new Expediente();

    protected override async Task OnInitializedAsync()
    {
        // Asignar propiedad y valores por defecto
        nuevoExpediente.PropiedadId = PropiedadId;
        nuevoExpediente.Estado = "Abierto";
        nuevoExpediente.FechaApertura = DateOnly.FromDateTime(DateTime.Now);
    }

    private async Task GuardarExpediente()
    {
        // 1. Guardar el nuevo expediente
        Db.Expedientes.Add(nuevoExpediente);
        await Db.SaveChangesAsync();

        // 2. Redirigir al detalle del expediente
        Navigation.NavigateTo($"/expedientes/details/{nuevoExpediente.ExpedienteId}");
    }

    private void Volver()
    {
        Navigation.NavigateTo("/properties");
    }
}
