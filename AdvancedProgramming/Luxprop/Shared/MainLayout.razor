@using Luxprop.Services
@inherits LayoutComponentBase
@inject SessionService SessionService
@inject NavigationManager Navigation

@if (isAuthenticated)
{
    <div class="layout-wrapper">

        <!-- TOP BAR -->
        <header class="top-bar">

            <!-- Marca izquierda -->
            <div class="brand-left">
                <img src="https://i.imgur.com/nmN7x14.png" class="brand-logo" />
                <span class="brand-title">2CRRE Docs</span>
            </div>

            <div class="user-menu">
                <div class="user-info" @onclick="ToggleMenu">
                    <span class="user-name">@userName (@role)</span>
                </div>

                @if (menuOpen)
                {
                    <div class="user-dropdown">
                        <a href="/profile">My Profile</a>
                        <a href="#" @onclick="Logout">Logout</a>
                    </div>
                }
            </div>


        </header>

        <!-- MENÚ PRINCIPAL -->
        <nav class="menu-bar">
            <NavLink href="@dashboardHref" class="menu-link">Dashboard</NavLink>
            <NavLink href="/documents" class="menu-link">Documents</NavLink>
            <NavLink href="/documentsVencidos" class="menu-link">Expired Documents</NavLink>
            <NavLink href="/graficos" class="menu-link">Graficos</NavLink>
            <NavLink href="/properties" class="menu-link">Properties</NavLink>
            <NavLink href="/historial-expedientes" class="menu-link">History</NavLink>
            <NavLink href="/reminders" class="menu-link">Reminders</NavLink>

            <NavLink href="/expedientes" class="menu-link">
                <i class="bi bi-folder2-open"></i> Expedientes
            </NavLink>

            <NavLink href="/tramites" class="menu-link">Tasks</NavLink>

            @if (role == "admin" || role == "agent")
            {
                <NavLink href="/chatadmin" class="menu-link"><i class="bi bi-headset"></i> Chat Panel</NavLink>
            }
            else
            {
                <NavLink href="/chat" class="menu-link"><i class="bi bi-chat-dots"></i> Chat</NavLink>
            }

            @if (role == "admin")
            {
                <NavLink href="/users" class="menu-link">Manage Users</NavLink>
            }
        </nav>

        <main class="page-content">
            @Body
        </main>

    </div>
}
else
{
    @Body
}

@code {
    private bool isAuthenticated;
    private string? userName;
    private string? roleRaw;
    private string role = "";
    private string dashboardHref = "/dashboard";
    private bool initialized;
    private bool menuOpen = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || initialized) return;
        initialized = true;

        await SessionService.LoadUserAsync();

        userName = await SessionService.GetUserNameAsync();
        roleRaw = await SessionService.GetUserRoleAsync();
        role = NormalizeRole(roleRaw);

        isAuthenticated = !string.IsNullOrWhiteSpace(userName);

        dashboardHref = role switch
        {
            "admin" => "/dashboard",
            "agent" => "/dashboardagent",
            "seller" => "/dashboardvend",
            "buyer" => "/dashboardcomp",
            _ => "/dashboard"
        };

        if (!isAuthenticated)
        {
            var uri = Navigation.Uri.ToLowerInvariant();
            var isPublic = uri.EndsWith("/login") || uri.EndsWith("/user/create");

            if (!isPublic)
                Navigation.NavigateTo("/login", true);
        }

        StateHasChanged();
    }

    private void ToggleMenu()
    {
        menuOpen = !menuOpen;
    }

    private async Task Logout()
    {
        await SessionService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    private static string NormalizeRole(string? name)
    {
        var n = name?.Trim().ToLowerInvariant();
        return n switch
        {
            "administrador" or "admin" => "admin",
            "agente" or "agent" => "agent",
            "vendedor" or "seller" => "seller",
            "comprador" or "buyer" or "cliente" => "buyer",
            _ => "user"
        };
    }
}

<style>
    /* USER MENU IN HEADER */

    .user-menu {
        position: relative;
        display: flex;
        align-items: center;
    }

    .user-info {
        display: flex;
        align-items: center;
        background-color: #0d505a;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .user-info:hover {
            background-color: #093e47;
        }

    .user-icon {
        margin-right: 8px;
    }

    .user-dropdown {
        position: absolute;
        right: 0;
        top: 45px;
        background: white;
        border-radius: 10px;
        width: 180px;
        padding: 8px 0;
        box-shadow: 0px 4px 18px rgba(0,0,0,0.15);
        z-index: 999;
    }

        .user-dropdown a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: #0d505a;
            font-weight: 600;
        }

            .user-dropdown a:hover {
                background-color: #f2f2f2;
            }
</style>
