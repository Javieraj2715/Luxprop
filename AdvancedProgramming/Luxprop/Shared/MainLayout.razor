﻿@using Luxprop.Services
@inherits LayoutComponentBase
@inject SessionService SessionService
@inject NavigationManager Navigation

@if (isAuthenticated)
{
    <div class="layout-wrapper">
        <!-- Top bar -->
        <header class="top-bar">
            <div class="brand-left">
                <img src="https://i.imgur.com/nmN7x14.png" class="brand-logo" />
                <span class="brand-title">2CRRE Docs</span>
            </div>

            <div class="brand-right">
                <span class="user-name">@userName (@role)</span>
                <button class="logout-btn" @onclick="Logout">Logout</button>
            </div>
        </header>

        <!-- Main menu -->
        <nav class="menu-bar">
            <NavLink href="@dashboardHref" class="menu-link">Dashboard</NavLink>
            <NavLink href="/documents" class="menu-link">Documents</NavLink>
            <NavLink href="/documentsVencidos" class="menu-link">Expired Documents</NavLink>
            <NavLink href="/graficos" class="menu-link">Graficos</NavLink>
            <NavLink href="/properties" class="menu-link">Properties</NavLink>
            <NavLink href="/historial-expedientes" class="menu-link">History</NavLink>
            <NavLink href="/reminders" class="menu-link">Reminders</NavLink>

            <NavLink href="/expedientes" class="menu-link">
                <i class="bi bi-folder2-open"></i> Expedientes
            </NavLink>
            <NavLink href="/tramites" class="menu-link">Tasks</NavLink>
            @* Chat dinámico según rol *@
            @if (role == "admin" || role == "agent")
            {
                <NavLink href="/chatadmin" class="menu-link"><i class="bi bi-headset"></i> Chat Panel</NavLink>
            }
            else
            {
                <NavLink href="/chat" class="menu-link"><i class="bi bi-chat-dots"></i> Chat</NavLink>
            }

            @* Solo admin *@
            @if (role == "admin")
            {
                <NavLink href="/users" class="menu-link">Manage Users</NavLink>
            }
        </nav>

        <main class="page-content">
            @Body
        </main>
    </div>
}
else
{
    @Body
}

@code {
    private bool isAuthenticated;
    private string? userName;
    private string? roleRaw;            // rol como viene de la BD (es/en)
    private string role = "";           // rol normalizado: admin|agent|seller|buyer
    private string dashboardHref = "/dashboard";
    private bool initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || initialized) return;
        initialized = true;

        // Cargar sesión antes de leer
        await SessionService.LoadUserAsync();

        userName = await SessionService.GetUserNameAsync();
        roleRaw = await SessionService.GetUserRoleAsync();
        role = NormalizeRole(roleRaw);

        isAuthenticated = !string.IsNullOrWhiteSpace(userName);

        // Dashboard dinámico por rol
        dashboardHref = role switch
        {
            "admin" => "/dashboard",
            "agent" => "/dashboardagent",
            "seller" => "/dashboardvend",
            "buyer" => "/dashboardcomp",
            _ => "/dashboard"
        };

        // Si no hay sesión y no es ruta pública → login
        if (!isAuthenticated)
        {
            var uri = Navigation.Uri.ToLowerInvariant();
            var isPublic = uri.EndsWith("/login") || uri.EndsWith("/user/create");
            if (!isPublic) Navigation.NavigateTo("/login", true);
        }

        StateHasChanged();
    }

    private async Task Logout()
    {
        await SessionService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    // Normaliza nombres es/en a un valor canónico
    private static string NormalizeRole(string? name)
    {
        var n = name?.Trim().ToLowerInvariant();
        return n switch
        {
            "administrador" or "admin" => "admin",
            "agente" or "agent" => "agent",
            "vendedor" or "seller" => "seller",
            "comprador" or "buyer" or "cliente" => "buyer",
            _ => string.Empty
        };
    }
}


