@using Luxprop.Services
@inherits LayoutComponentBase
@inject SessionService SessionService
@inject NavigationManager Navigation

@if (isAuthenticated)
{
    <div class="layout-wrapper">

        <!-- ✅ Barra superior -->
        <header class="top-bar">
            <div class="brand-left">
                <img src="https://i.imgur.com/nmN7x14.png" class="brand-logo" />
                <span class="brand-title">2CRRE Docs</span>
            </div>

            <div class="brand-right">
                <span class="user-name">@userName</span>
                <button class="logout-btn" @onclick="Logout">Logout</button>
            </div>
        </header>

        <!-- ✅ Menú principal -->
        <nav class="menu-bar">
            <NavLink href="/dashboard" class="menu-link" Match="NavLinkMatch.All">Dashboard</NavLink>
            <NavLink href="/documents" class="menu-link">Documents</NavLink>
            <NavLink href="/properties" class="menu-link">Properties</NavLink>

            @* 🔹 Chat dinámico según rol *@
            @if (userRole == "Administrador" || userRole == "Agente")
            {
                <NavLink href="/chatadmin" class="menu-link">
                    <i class="bi bi-headset"></i> Chat Panel
                </NavLink>
            }
            else
            {
                <NavLink href="/chat" class="menu-link">
                    <i class="bi bi-chat-dots"></i> Chat
                </NavLink>
            }

            @if (userRole == "Administrador")
            {
                <NavLink href="/users" class="menu-link">Manage Users</NavLink>
            }
        </nav>

        <!-- ✅ Contenido dinámico -->
        <main class="page-content">
            @Body
        </main>
    </div>
}
else
{
    @Body
}

@code {
    private bool isAuthenticated = false;
    private string? userName;
    private string? userRole;
    private bool hasInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasInitialized)
        {
            hasInitialized = true;

            userRole = await SessionService.GetUserRoleAsync();
            userName = await SessionService.GetUserNameAsync();
            isAuthenticated = !string.IsNullOrEmpty(userName);

            if (!isAuthenticated)
            {
                var currentUri = Navigation.Uri.ToLower();
                if (!currentUri.EndsWith("/login") && !currentUri.EndsWith("/user/create"))
                {
                    Navigation.NavigateTo("/login", true);
                }
            }

            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await SessionService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }
}
