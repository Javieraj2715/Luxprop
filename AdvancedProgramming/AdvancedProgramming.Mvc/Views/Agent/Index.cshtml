@{
    ViewBag.Title = "Agent Console";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Agent Console</h2>

<div style="display:flex; gap:16px; align-items:flex-start;">
    <div style="width:320px;">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
            <button id="refresh" class="btn btn-secondary btn-sm">Refresh</button>
            <span class="text-muted">Open threads</span>
        </div>
        <ul id="threads" style="list-style:none; padding-left:0; margin:0; border:1px solid #e5e5e5; border-radius:8px; max-height:420px; overflow:auto;"></ul>
    </div>

    <div style="flex:1;">
        <div id="threadHeader" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div>
                <strong id="threadTitle">No thread selected</strong>
                <div class="text-muted" id="threadMeta"></div>
            </div>
            <div>
                <button id="closeThreadBtn" class="btn btn-outline-danger btn-sm" disabled>Close thread</button>
            </div>
        </div>

        <div id="chat"
             style="border:1px solid #e5e5e5; border-radius:8px; height:360px; overflow:auto; padding:10px; background:#fafafa;"></div>

        <div style="display:flex; gap:8px; margin-top:10px;">
            <input id="msg" class="form-control" placeholder="Type a reply as Agent..." autocomplete="off" />
            <button id="send" class="btn btn-primary" disabled>Send</button>
        </div>
    </div>
</div>

@section scripts{
    <script>
(function(){
  if (typeof window.jQuery === 'undefined') { alert('jQuery is required.'); return; }

  var openThreadsUrl = '@Url.Action("OpenThreads","Chat")';
  var historyUrl     = '@Url.Action("History","Chat")';
  var pollUrl        = '@Url.Action("Poll","Chat")';
  var agentSendUrl   = '@Url.Action("AgentSend","Chat")';
  var closeUrl       = '@Url.Action("Close","Chat")';

  var current = 0, lastId = 0, timer = null;
  var $threads = $('#threads'), $chat = $('#chat');
  var $msg = $('#msg'), $send = $('#send'), $refresh = $('#refresh'), $close = $('#closeThreadBtn');
  var $title = $('#threadTitle'), $meta = $('#threadMeta');

  function addLine(sender, text){
    var $d = $('<div/>').text(sender + ': ' + text);
    $chat.append($d);
    $chat.scrollTop($chat.prop('scrollHeight'));
  }
  function clearChat(){ $chat.empty(); lastId = 0; }
  function setControlsEnabled(en){ $send.prop('disabled', !en); $msg.prop('disabled', !en); $close.prop('disabled', !en); }

  function loadThreads(){
    $.getJSON(openThreadsUrl, function(rows){
      $threads.empty();
      if (!rows || !rows.length) { $threads.append($('<li/>').text('No open threads').css({padding:'8px',color:'#777'})); return; }
      rows.forEach(function(r){
        var label = '#' + r.ChatThreadId + ' — ' + (r.ClientName || r.ClientEmail || 'Guest');
        var $li = $('<li/>').css({ padding:'8px 10px', borderBottom:'1px solid #eee', cursor:'pointer', background:'#fff' })
                            .attr('data-id', r.ChatThreadId).attr('data-label', label).text(label);
        if (current === r.ChatThreadId) $li.css({ background:'#f0f7ff' });
        $threads.append($li);
      });
    });
  }

  function loadHistory(id, label, cb){
    $.getJSON(historyUrl, { id: id }, function(items){
      clearChat();
      (items || []).forEach(function(m){
        addLine(m.Sender, m.Text);
        if (m.ChatMessageId > lastId) lastId = m.ChatMessageId;
      });
      $title.text(label || ('#' + id));
      $meta.text('Messages: ' + (items ? items.length : 0));
      setControlsEnabled(true);
      cb && cb();
    });
  }

  function startPoll(){
    stopPoll();
    timer = setInterval(function(){
      $.getJSON(pollUrl, { id: current, sinceId: lastId }, function(items){
        if (items && items.length){
          items.forEach(function(m){
            addLine(m.Sender, m.Text);
            if (m.ChatMessageId > lastId) lastId = m.ChatMessageId;
          });
          $chat.scrollTop($chat.prop('scrollHeight'));
        }
      });
    }, 1200);
  }
  function stopPoll(){ if (timer){ clearInterval(timer); timer=null; } }

  $refresh.on('click', loadThreads);

  $threads.on('click', 'li', function(){
    var id = parseInt($(this).attr('data-id'));
    var label = $(this).attr('data-label') || ('#' + id);
    if (!id) return;

    stopPoll();
    current = id;
    $threads.children().css({ background:'#fff' });
    $(this).css({ background:'#f0f7ff' });

    loadHistory(current, label, startPoll);
  });

  function send(){
    var txt = $msg.val().trim();
    if (!txt || !current) return;
    $msg.val('');
    addLine('Agent', txt); // eco optimista
    $.post(agentSendUrl, { threadId: current, text: txt });
  }
  $('#send').on('click', send);
  $('#msg').on('keydown', function(e){ if (e.key==='Enter') send(); });

  $('#closeThreadBtn').on('click', function(){
    if (!current) return;
    if (!confirm('Close thread #' + current + '?')) return;
    $.post(closeUrl, { id: current })
      .done(function(){
        addLine('System', 'Thread closed.');
        setControlsEnabled(false);
        stopPoll();
        current = 0;
        loadThreads();
        $title.text('No thread selected');
        $meta.text('');
      });
  });

  loadThreads();
})();
    </script>
}
